name: OpenWrt List Sync
on:
  schedule:
    - cron: '0 3 1 * *'  # 每月1号凌晨3点执行 
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      # ------------------------- 初始化阶段 -------------------------
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # 启用增量更新所需的历史记录 

      # ------------------------- 数据同步阶段 -------------------------
      - name: 同步官方列表
        run: |
          # 保留原有注释
          grep '^#' scripts/Models > models_comments || true
          grep '^#' scripts/Archs > archs_comments || true

          # 同步最新数据（保留原始格式）
          wget -qO- https://openwrt.org/supported_devices | 
            awk '/<table class="device-list">/,/<\/table>/ {print}' |
            html2text -width 1000 |
            sed -n '/^| Model/,/^$/p' > scripts/Models.new
          
          wget -qO- https://openwrt.org/architectures |
            grep -Eo '([a-z0-9]+/[a-z0-9_]+)' |
            sort -u > scripts/Archs.new

          # 合并注释与新数据
          cat models_comments scripts/Models.new > scripts/Models
          cat archs_comments scripts/Archs.new > scripts/Archs

      # ------------------------- 校验阶段 ------------------------- 
      - name: 格式校验
        run: |
          # 设备列表校验
          if ! grep -qE '^[^:]+:[^:]+' scripts/Models; then
            echo "::error::Models 文件格式错误"
            exit 1
          fi

          # 架构列表校验
          if grep -qE '[^/]/[^/ ]+' scripts/Archs; then
            echo "::error::Archs 包含非法架构格式"
            exit 1
          fi

      - name: 兼容性测试
        uses: docker://openwrtorg/sdk:latest
        with:
          args: |
            # 验证架构映射关系
            while IFS=: read -r model arch; do
              [[ "$arch" =~ ^# ]] && continue
              if ! grep -qxF "$arch" /github/workspace/scripts/Archs; then
                echo "::error::设备 $model 映射到无效架构 $arch"
                exit 1
              fi
            done < /github/workspace/scripts/Models

      # ------------------------- 增量提交阶段 ------------------------- 
      - name: 检测变更
        id: changes
        run: |
          # 排除注释行的变更检测
          changed_files=$(git diff --ignore-matching-lines='^#' HEAD^ HEAD -- scripts/ | wc -l)
          echo "changed=$([ $changed_files -gt 0 ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: 提交变更
        if: steps.changes.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: 同步OpenWrt列表 (增量更新)"
          file_pattern: scripts/
          skip_fetch: true

      # ------------------------- 版本管理阶段 ------------------------- 
      - name: 创建版本快照
        if: steps.changes.outputs.changed == 'true'
        run: |
          current_date=$(date +%Y%m%d)
          git tag sync-$current_date
          git push origin --tags

      - name: 清理旧版本
        run: |
          # 保留最近5个版本
          git tag -l 'sync-*' --sort=-creatordate | tail -n +6 | xargs -I {} git push origin --delete {}
